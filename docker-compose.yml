version: '3.9'

services:
    zookeeper-1:
        image: confluentinc/cp-zookeeper:latest
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - 22181:2181

    zookeeper-2: 
        image: confluentinc/cp-zookeeper:latest
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - 32181:2181

    kafka-1:
        image: confluentinc/cp-kafka:latest
        depends_on:
            - zookeeper-1
            - zookeeper-2

        ports:
            - 29092:29092 
        environment:
            KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181,zookeeper-2:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092,PLAINTEXT_HOST://localhost:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

    kafka-2:
        image: confluentinc/cp-kafka:latest
        depends_on:
            - zookeeper-1
            - zookeeper-2

        ports:
            - 39092:39092 
        environment:
            KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181,zookeeper-2:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:9092,PLAINTEXT_HOST://localhost:39092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

    redis:
        image: bitnami/redis:latest
        environment:
            ALLOW_EMPTY_PASSWORD: "yes"
        ports:
            - 6379:6379

    postgres:
        image: postgres:latest
        environment:
            POSTGRES_DB: "watermelon"
            POSTGRES_USER: "postgres"
            POSTGRES_PASSWORD: "postgres"
            PGDATA: "/var/lib/postgresql/data/dbdata/pgdata"
        volumes:
            - ./dbdata/pgdata:/var/lib/postgresql/data
        ports:
            - 9467:9467

    clickhouse:
        image: clickhouse-exposed 
        depends_on:
            - kafka-1
            - kafka-2
        volumes:
            - ./dbdata/clickhouse/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
            - ./dbdata/clickhouse:/var/lib/clickhouse/chdata
        ports:
            - 5050:5050
        
        

